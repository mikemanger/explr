(api=api||{}).lastfm={},api.lastfm.key="865b1653dbe200905a5b75d9d839467a",api.lastfm.url="https://ws.audioscrobbler.com/2.0/",api.lastfm.send=function(r,s,t,l){var e,c,n=api.lastfm.url+"?method="+r+"&api_key="+api.lastfm.key+"&format=json",d=(l=void 0===l?10:l,!1);s.forEach(function(t){n+="&"+t[0]+"="+(t[1]+"").replace("&","%26").replace("/","%2F").replace("+","%2B").replace("\\","%5C")}),function a(o,i){e=d3.json(n,function(t,e){if(d)clearTimeout(u);else{if(t?e=JSON.parse(t.response):e.error&&(t=e),t){var n={method:r,errorCode:t.error,try:o,options:s};if((29===t.error||8===t.error)&&o<l)return console.log("Retry request: ",n),void setTimeout(a.bind(null,o+1,i),3e3*o);l<=o&&(console.log("Retry failed after "+l+" attempts, will stop trying.",n),clearTimeout(u),d=!0,t="ERROR",e={error:"Took to long to respond"})}c=!0,i(t,e)}})}(0,t);var u=setTimeout(function(){c||(e.abort(),t("ERROR",{error:"Took to long to respond"}))},2e4);return{abort:function(){d=!0,e.abort()}}};var api=api||{},superCount=0;!function(i){d3.csv("assets/data/countries.csv",function(t,e){alias=d3.nest().key(function(t){return t&&t.tag?t.tag.toLowerCase():""}).map(e),cname=d3.nest().key(function(t){return t.name.toLowerCase()}).map(e),api.getCountry=function(d,u){api.lastfm.send("artist.gettoptags",[["artist",d]],function(t,e){var i,r,s,l,c=!0;!t&&e.toptags&&e.toptags.tag&&e.toptags.tag.length?(e.toptags.tag.forEach(function(t,e){if(c){var n;s=t.name.toLowerCase();var a=["georgia","ireland"],o=["spanish","french","english","portuguese","russian","italian","japanese","korean","indian","swedish","irish"];try{if(cname[s]&&cname[s][0].id){for(l=!1,e=0;e<a.length;e++)cname[s][0].name.toLowerCase()==a[e]&&(l=a[e]);l?(i=cname[s][0].id,r=cname[s][0].name):(n=cname[s][0].id,countryName=cname[s][0].name)}else if(alias[s]&&alias[s][0].id){for(l=!1,e=0;e<o.length;e++)alias[s][0].tag.toLowerCase()==o[e]&&(l=o[e]);l?(i=alias[s][0].id,r=alias[s][0].name):(n=alias[s][0].id,countryName=alias[s][0].name)}n&&(u({artist:d,id:n,tag:s,name:countryName}),c=!1)}catch(t){}}}),c&&(i?(console.log("Potentially incorrect country for '"+d+"': "+r+", using only the tag '"+l+"'"),u({artist:d,id:i,tag:s,name:r}),c=!1):u({artist:d}))):u({artist:d})})},api.getCountries=function(t,e){function a(){n++,superCount++,d3.select("#loading-text").html("Loading artists...<br>("+superCount+"/"+SESSION.total_artists+")<br>You can start exploring,<br>but it might interfere<br>with loading your artists."),n===t.length&&(i.localStorage.artists=JSON.stringify(STORED_ARTISTS),e(o))}var o=[],n=0;t.forEach(function(e,t){if(STORED_ARTISTS[e]&&STORED_ARTISTS[e].country){var n=STORED_ARTISTS[e].country;n.artist=e,o.push(n),a()}else{(new Date).getTime();api.getCountry(e,function(t){STORED_ARTISTS[e]=STORED_ARTISTS[e]||{},STORED_ARTISTS[e].country={id:t.id,name:t.name},o.push(t),a()})}})}}),api.getTags=function(n,a){STORED_ARTISTS[n]&&STORED_ARTISTS[n].tags?a(STORED_ARTISTS[n].tags):(STORED_ARTISTS[n]=STORED_ARTISTS[n]||{},STORED_ARTISTS[n].tags=[],api.lastfm.send("artist.gettoptags",[["artist",n]],function(t,e){STORED_ARTISTS[n].tags=e.toptags.tag,i.localStorage.artists=JSON.stringify(STORED_ARTISTS),a(STORED_ARTISTS[n].tags)}))},api.getArtistInfo=function(a,o){var i=[];api.lastfm.send("artist.getinfo",[["artist",a]],function(t,e){var n=[];e.artist.tags.tag&&e.artist.tags.tag.forEach(function(t,e){n.push(t.name)}),i.push({name:a,url:e.artist.url,image:e.artist.image[3]["#text"],description:e.artist.bio.summary,tags:n}),o(i)})};var n=[];api.cancelRecommendationRequests=function(){n.forEach(function(t){t.abort()}),n=[]},api.getRecommendations=function(l,c){api.cancelRecommendationRequests();var d=[],t=USER_TAGS.slice(0,15),u=d3.nest().key(function(t){return t.tag}).rollup(function(t){return t[0].count}).map(t),e=api.lastfm.send("tag.gettopartists",[["tag",l],["limit",100]],function(t,e){var r={};if(!t&&!e.error&&e.topartists&&e.topartists.artist){var s=e.topartists.artist;s.forEach(function(o,i){r[o.name]=[];var t=api.lastfm.send("artist.gettoptags",[["artist",o.name]],function(t,e){var n=!e.error&&!!e.toptags.tag;if((d3.select("#rec-loading-current").html("("+o.name+")"),n)&&d3.nest().key(function(t){return t.name}).map(e.toptags.tag)[l])for(var a=e.toptags.tag.length-1;0<=a;a--)u[e.toptags.tag[a].name]&&5<e.toptags.tag[a].count&&r[o.name].push(e.toptags.tag[a].name);i===s.length-1&&(d3.keys(r).forEach(function(t){d.push({name:t,count:r[t].length,tags:r[t]})}),d.sort(function(t,e){return e.count<t.count?-1:e.count>t.count?1:0}),c(d))});n.push(t)})}else c([])});n.push(e)},api.getFriends=function(t){api.lastfm.send("user.getFriends",[["user",SESSION.name]],t)}}(window,document);var STORED_ARTISTS=JSON.parse(window.localStorage.artists||"{}"),USER_TAGS=[],CACHED_USERS=JSON.parse(window.localStorage.cached_users||"{}"),SESSION={},CACHED_NO_COUNTRIES=JSON.parse(window.localStorage.no_countries||"{}");!function(){function a(t){d=d.concat(t);var e=d3.select(".no-countries ul");t.forEach(function(t){e.append("li").html('<a href="'+t.url+'" target="blank" class="no-countries__link">'+t.artist+"</a>")}),window.localStorage.no_countries=JSON.stringify(d),d.length&&d3.select(".no-countries").style({visibility:"visible","pointer-events":"all"})}function n(t,e){(t||e.error)&&e&&6===e.error&&(alert("User not found"),window.location.assign(window.location.origin+window.location.pathname));var o=0,r={},s=e.topartists.artist;s.forEach(function(t,e){setTimeout(function(){api.lastfm.send("artist.gettoptags",[["artist",t.name]],function(t,e){if(taglist=e.toptags.tag,taglist)for(var n=Math.min(taglist.length,10),a=0;a<n;a++)r[taglist[a].name]?r[taglist[a].name]++:r[taglist[a].name]=1;++o==s.length-1&&(USER_TAGS=[],forbidden=["american","swedish","british","female vocalists","male vocalists","german","seen live","english","singer-songwriter","spanish","french"],d3.keys(r).forEach(function(t){var e=!1;for(i=0;i<forbidden.length;i++)t===forbidden[i]&&(e=!0);e||USER_TAGS.push({tag:t,count:r[t]})}),USER_TAGS.sort(function(t,e){return e.count<t.count?-1:e.count>t.count?1:0}),console.log("Done getting tags, saved to localStorage.user_tags"),window.localStorage.user_tags=JSON.stringify(USER_TAGS))})},3e3*Math.random())})}var r,o,s=1,l={},c=0,t=["Malawi","Malaysia","Peru","Sierra Leone","Trinidad & Tobago","Greece","Laos","Iran","Haiti","Nicaragua","Mongolia","Slovakia"],d=[],u=function(){api.lastfm.send("library.getartists",[["user",r],["limit",50],["page",s]],function(t,e){if(""===e)return console.error('Got empty string ("") as response, skipping page.'),s++,void u();if(t||e.error){console.error("Error in getAllArtists, page "+s,t,e),c++<5?u():confirm("Last.fm took too long to respond.\n\nPress OK to refresh the page and try again, or Cancel to use the page as it is.")&&(window.localStorage.clear(),window.localStorage.artists=JSON.stringify(STORED_ARTISTS),window.location.reload())}else{if(c=0,1===s&&(SESSION.total_artists=+e.artists["@attr"].total,o=+e.artists["@attr"].totalPages,0===SESSION.total_artists))return d3.select(".bubblingG").remove(),d3.select("#loading-text").html("You haven't listened to any<br> artists yet. Start scrobbling with <br>                                                        <a href='http://evolver.fm/2012/05/08/how-to-scrobble-to-last-fm-from-itunes-spotify-and-more/'>your favorite music player!</a>"),void d3.select(".loader").style("pointer-events","all");s++;var n=[];e.artists.artist.forEach(function(t){var e=STORED_ARTISTS[t.name]||{};e.playcount=+t.playcount,e.url=t.url,e.image=[t.image[3]],STORED_ARTISTS[t.name]=e,n.push(t.name)}),window.localStorage.artists=JSON.stringify(STORED_ARTISTS),api.getCountries(n,function(t){var e=d3.nest().key(function(t){return t.id}).rollup(function(t){return t}).map(t);d3.keys(e).forEach(function(t){l[t]=l[t]||{},l[t][r]=l[t][r]||[];var n=l[t][r];(n=n.concat(e[t])).forEach(function(t,e){n[e].image=STORED_ARTISTS[t.artist].image[0]["#text"],n[e].url=STORED_ARTISTS[t.artist].url,n[e].playcount=STORED_ARTISTS[t.artist].playcount}),l[t][r]=n}),a(t.filter(function(t){return!t.id})),map.putCountryCount(l),o<s?g():u()})}})},g=function(){var t=d3.select(".loader");t.transition().duration(2e3).style("opacity",0).each("end",function(){t.remove()}),d3.select("#progress-text").transition().delay(5e3).duration(1500).style("opacity",0),(CACHED_USERS={})[r]=(new Date).getTime(),window.localStorage.cached_users=JSON.stringify(CACHED_USERS),window.localStorage.countryCountObj=JSON.stringify(l)},e=window.location.href.split("username=")[1];e?(window.addEventListener("keydown",function(t){switch(t.keyCode){case 83:screenshot.render(),ga("send",{hitType:"event",eventCategory:"Hotkeys",eventAction:"Take screenshot",eventLabel:"test"});break;case 84:nextTheme(),ga("send",{hitType:"event",eventCategory:"Hotkeys",eventAction:"Cycle theme",eventLabel:"test"})}}),15<e.length&&(e=e.substr(0,15)),r=e,SESSION.name=e,function(){ga("send","event","splash screen","Go!","test");var t=d3.select("#welcome-container");if(t.transition().duration(2e3).style("opacity",0).each("end",function(){t.remove()}),d3.select(".loader").transition().duration(2e3).style("opacity",1),d3.select("#loading-text").html("Getting library..."),setTimeout(function(){"Getting library..."===d3.select("#loading-text").html()&&(d3.select("#loading-text").html("Last.fm is taking<br>a long time to<br>respond..."),setTimeout(function(){"Last.fm is taking<br>a long time to<br>respond..."===d3.select("#loading-text").html()&&d3.select("#loading-text").html("Maybe <a href='http://last.fm' target='_blank'>last.fm</a> has<br>gone offline...").style("pointer-events","all")},8e3))},8e3),d3.selectAll(".on-map-view").style({visibility:"visible"}),api.lastfm.send("user.gettopartists",[["user",r],["period","12months"],["limit","50"]],n),api.getFriends(function(t,e){try{function n(){i.html(""),i.append("a").attr({href:window.location.origin+window.location.pathname+"?username="+a[o].name,target:"_self"}).html(a[o].name)}var a=e.friends.user,o=0,i=d3.select("#friend-name");d3.selectAll(".arrow").on("click",function(){o=d3.select(this).classed("left")?0===o?a.length-1:o-1:(o+1)%a.length,n()}),n(),d3.select("#friends #msg").html("Check out "+r+"'s friends"),d3.select("#friends").transition().duration(1e3).style("opacity",1)}catch(t){console.error("getFriends()",t),d3.select("#friends").html("&nbsp;Couldn't find any<br>friends on last.fm :(&nbsp;"),d3.select("#friends").transition().duration(1e3).style("opacity",1)}}),CACHED_USERS[r])console.log("No new artists on last.fm!"),l=JSON.parse(window.localStorage.countryCountObj),a(JSON.parse(window.localStorage.no_countries)),api.lastfm.send("library.getartists",[["user",r],["limit",1],["page",1]],function(t,e){SESSION.total_artists=+e.artists["@attr"].total}),setTimeout(function(){map.putCountryCount(l),g()},1e3);else{var e=window.localStorage.theme;window.localStorage.clear(),e&&(window.localStorage.theme=e),u()}}()):(d3.select("#welcome-container").style("visibility","visible"),d3.select("#randomCountry").html(t[Math.floor(Math.random()*t.length)]+"?"))}();var legend,map={},colorArray=["#feebe2","#feebe2","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177"],countryScore=0;!function(d,u){d3.select(d).on("resize",function(){d.clearTimeout(t),t=d.setTimeout(function(){L(!0),F([0,0],1)},200)});var l,c,a,g,m,r,s,f,h,S="artists",v=d3.behavior.zoom().scaleExtent([1,9]).on("zoom",F);countryCount={};var b,T=[0,1,2,3,4,5,6],e=1,n=0,o=d.localStorage.theme||"pink_white";function w(){l=d.innerHeight-5,c=u.getElementById("map-container").offsetWidth}function C(t){if(countryCount[t.id]){var e=0;for(i=0;i<countryCount[t.id].length;i++)e+=countryCount[t.id][i].playcount;return e}return 0}function E(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g," ")}function A(){var t=-1;switch(S){case"artists":for(t=e,i=0;i<5;i++)T[i]=Math.pow(Math.E,Math.log(t)/6*(i+1));T=[0,1,T[0],T[1],T[2],T[3],T[4]];break;case"scrobbles":for(t=n,i=0;i<7;i++)T[i]=Math.pow(Math.E,Math.log(t)/7*(i+1));T=[0,1,T[1],T[2],T[3],T[4],T[5]]}b=d3.scale.threshold().domain(T).range(colorArray)}map.drawPlays=function(){S="scrobbles",L()};var k,R,x,t,_=d3.select("#map-container").append("div").attr("class","tooltip hidden"),O=d3.select("body").append("div").attr("class","infoContainer hidden").attr("id","infoContainer"),I=(d3.select("#infoContainer").append("div").attr("class","artistContainer").attr("id","artistContainer"),d3.select("#infoContainer").append("div").attr("class","cnameDiv").attr("id","cname")),D=(d3.select("#artistContainer").append("div").attr("class","detailsDiv").attr("id","details"),d3.select("#artistContainer").append("div").attr("class","recoDiv").attr("id","recommendations"),d3.select("#artistContainer").append("div").attr("class","artistSummaryDiv").attr("id","summary"),{blue_black:["#03020D","#140E1F","#2A075A","#321C78","#362688","#3E3CA7","#4651C5","#5371F4"],green_black:["#03020D","#08120C","#032F30","#064137","#0E6745","#158C54","#1CB162","#28EA78"],pink_black:["#03020D","#1F0310","#4B0627","#5C1138","#7E285C","#A13F80","#C355A4","#F778DA"],pink_white:["#feebe2","#feebe2","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177"],green_white:["#ece2f0","#F6EBFA","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c"],red_white:["#F0F0D8","#F0F0D8","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"]});function N(t,e){g=d3.geo.naturalEarth().translate([t/2,e/2+.08*e]).scale(t/1.7/Math.PI),m=d3.geo.path().projection(g),r=d3.select("#map-container").append("svg").attr("id","map-svg").attr("width",t).attr("height",e).style("margin-left",u.getElementById("map-container").offsetWidth/2-t/2).call(v).on("click",J).append("g"),s=r.append("g"),r.append("g").attr("id","legend"),r.append("text").attr({id:"filter-text",class:"legend"}),r.append("text").attr({id:"filter",class:"legend"})}function M(t,e){var n=s.selectAll(".country").data(t);d3.select("#progress-bar").style({height:countryScore/197*100+"%","background-color":colorArray[6]});d3.select("#countryCount").style({"background-color":colorArray[1],"border-color":colorArray[6]}).on("mousemove",function(){d3.select("#progress-text").transition().duration(150).style("opacity",.9)}).on("mouseout",function(){d3.select("#progress-text").transition().duration(150).style("opacity",0)}),d3.select("#progress-text").html("Scrobbled from "+countryScore+"/197 countries"),e&&n.enter().insert("path").attr("class","country").attr("d",m).attr("id",function(t,e){return t.id}).attr("title",function(t,e){return t.properties.name}).style("fill",function(){return b(0)}),n.transition().style("fill",function(t){switch(S){case"artists":return countryCount[t.id]?b(countryCount[t.id].length):b(0);case"scrobbles":return b(C(t))}}),R=u.getElementById("map-container").offsetLeft,x=u.getElementById("map-container").offsetTop,n.on("mousemove",function(n,t){var a;f.forEach(function(t,e){t.id===n.id&&(a=t.name,t.tag)});var e=d3.mouse(r.node()).map(function(t){return parseInt(t)});_.classed("hidden",!1).attr("style","left:"+(e[0]+R+20)+"px;top:"+(e[1]+x+10)+"px").html(a+(countryCount[n.id]?"<br>"+countryCount[n.id].length+" artists, "+E(C(n))+" scrobbles":""))}).on("mouseout",function(t,e){_.classed("hidden",!0)}).on("click",function(n,t){j(n),f.forEach(function(t,e){t.id===n.id&&(t.name,t.tag,n.id)});d3.mouse(r.node()).map(function(t){return parseInt(t)});k.on("click",function(t,e){G(),j(h)})})}function L(t){w(),t&&(d3.select("#map-svg").remove(),N(c,l)),e=d3.max(d3.keys(countryCount),function(t){return countryCount[t].length}),n=d3.max(d3.keys(countryCount),function(t){return C({id:t})}),A(),function(){for(var t=0,e=T.length;t<e;)T[t]=Math.ceil(T[t]),t++;var a=[E(T[0])+"",T[1]+"-"+(T[2]-1),T[2]+"-"+(T[3]-1),T[3]+"-"+(T[4]-1),T[4]+"-"+E(T[5]-1),E(T[5])+"-"+E(T[6]-1),"> "+E(T[6])];r.select("g#legend").selectAll("g.legend").remove(),legend=r.select("g#legend").selectAll("g.legend").data(T),t=.03*c;var n=.03*l,o=r.select("#filter-text").attr("x",t).attr("y",l-n-20*T.length-30).text("Number of ");r.select("#filter").attr("x",t+o[0][0].getComputedTextLength()+5).attr("y",l-n-20*T.length-30).text(S).on("click",function(){S="artists"===S?"scrobbles":"artists",L()}),d3.select(".no-countries").style("bottom",n+20*T.length+30+30+"px");var i=legend.enter().append("g").attr("class","legend");i.append("rect").attr("x",t).attr("y",function(t,e){return l-20*e-40-n}).attr("width",20).attr("height",20).style("fill",function(t){return b(t)}),i.append("text").attr("x",t+30).attr("y",function(t,e){return l-20*e-20-4-n}),legend.selectAll("text").data(T).text(function(t,e,n){return a[n]})}(),M(a,t)}function F(t,e,n){var a=t||!!d3.event&&d3.event.translate||v.translate(),o=e||!!d3.event&&d3.event.scale||v.scale();t||e||!h||(H(!1),G(),h=null);var i=l/4;a[0]=Math.min(c/l*(o-1),Math.max(1.2*c*(1-o),a[0])),a[1]=Math.min(i*(o-1)+i*o,Math.max(l*(1-o)-i*o,a[1])),v.translate(a),v.scale(o),n?s.transition().duration(950).attr("transform","translate("+a+")scale("+o+")"):s.attr("transform","translate("+a+")scale("+o+")"),d3.selectAll(".country").style("stroke-width",1.5/o)}function J(){g.invert(d3.mouse(this))}function U(r){var s,l;if(f.forEach(function(t,e){t.id===r.id&&(s=t.name,l=t.tag)}),d3.select("#recommendations").html(""),O.classed("hidden",!1).transition().style("opacity",1).duration(750),d3.selectAll("#countryCount, .on-map-view").classed("hidden",!0),k=d3.select("#infoContainer").append("button").attr("type","button").attr("class","close-button").html("X"),I.append("div").attr("class","cnameContainer").attr("id","cnameCont").append("h1").html(s),d3.select("#cnameCont").append("h5").html(function(){return countryCount[r.id]?E(countryCount[r.id].length)+" artists, "+E(C(r))+" scrobbles":"No artists yet - Find new here ->"}),countryCount[r.id]){var o=0,c=0;function d(){t(o+1,o+5,!1),ga("send",{hitType:"event",eventCategory:"Artist viewer",eventAction:"Next five",eventLabel:"test"})}function u(){t(o-9,o-5,!1),ga("send",{hitType:"event",eventCategory:"Artist viewer",eventAction:"Previous five",eventLabel:"test"})}function t(t,e,n){for(d3.selectAll(".scrobbled").remove(),i=t-1;i<=e-1;i++)if(countryCount[r.id][i]){var a=d3.select("#details").append("div").attr({class:"scrobbled artist-div lowlight","data-artist":countryCount[r.id][i].artist}).on("click",function(){d3.selectAll(".artist-div").classed({lowlight:!0,highlight:!1}),d3.select(this).classed({highlight:!0,lowlight:!1}),B(d3.select(this).attr("data-artist"))});a.append("a").style("display","block").append("div").attr("class","image-div").style("background-image","url('"+countryCount[r.id][i].image+"' )"),a.append("div").attr("class","play-count-div").append("p").html("<b>"+countryCount[r.id][i].artist+"</b><br>"+countryCount[r.id][i].playcount+" scrobbles").attr("class","details-p"),c++}else i=e;t<o?o=5*Math.ceil((o-c)/5):o<e&&(o+=c),c=0,10<=o&&!n?d3.selectAll(".artist-control.left").classed("disabled",!1).on("click",function(){u()}):d3.selectAll(".artist-control.left").classed("disabled",!0).on("click",function(){d3.select(this).on("click",null)}),o>countryCount[r.id].length-1?d3.selectAll(".artist-control.right").classed("disabled",!0).on("click",function(){d3.select(this).on("click",null)}):d3.selectAll(".artist-control.right").classed("disabled",!1).on("click",function(){d()})}d3.select("#details").append("div").html('<span>Your top artists tagged with </span><span class="demonym">#'+s+'</span><span> or </span><span class="demonym">#'+l+"</span><span>: </span>").attr("class","topartists-desc"),d3.select("#artistContainer").append("i").attr("class","fa artist-control right fa-angle-right").on("click",function(){d()}),d3.select("#artistContainer").append("i").attr("class","fa artist-control left disabled fa-angle-left").on("click",function(){u()}),t(1,5,!0)}else console.log("landet har inga lyssnade artister");d3.select("#recommendations").append("h4").html("You may like: ").attr("class","topartists-desc");var g=d3.select("#recommendations").append("div").attr("class","recLoadingDiv"),m=g.append("span").attr("id","rec-loading").html("Looking for artists tagged #"+l);g.append("img").attr({id:"rec-loading-img",src:"assets/img/loader_horizontal.gif"}).style({display:"inline-block",margin:"0 5px"}),g.append("span").attr("id","rec-loading-current"),api.getRecommendations(l,function(o){h&&h.id===r.id&&(m.html("Looking for artists tagged #"+s),api.getRecommendations(s,function(t){if(h&&h.id===r.id){m.html("Loading images for recommended artists");for(var e=o.concat(t),n={},a=0;a<e.length;a++)n[e[a].name]=e[a];for(key in e=new Array,n)e.push(n[key]);for(e.sort(function(t,e){return e.count<t.count?-1:e.count>t.count?1:0}),0===(e=function(t){for(var e=t.length-1;0<e;e--){var n=Math.floor(Math.random()*(e+1)),a=t[e];t[e]=t[n],t[n]=a}return t}(e=e.slice(0,20))).length&&(g.remove(),d3.select("#recommendations").append("p").html("We couldn't find any good "+l+" recommendations for you :-( "),d3.select("#recommendations").append("a").attr({href:"https://www.last.fm/tag/"+s,target:"_blank"}).html("Try searching last.fm yourself!")),a=0;a<Math.min(e.length,5);a++){if(h.id!==r.id)return;api.getArtistInfo(e[a].name,function(t){g.remove();t[0].url;var e=t[0].image,n=t[0].name,a=d3.select("#recommendations").insert("div","#summaryText").attr("class","artist-div lowlight");a.append("a").style("display","block").append("div").attr("class","image-div").style("background-image","url('"+e+"')"),a.append("div").attr("class","recoArtistInfoDiv").append("p").html("<b>"+n+"</b>").attr("class","details-p"),a.on("click",function(){d3.selectAll(".artist-div").classed({lowlight:!0,highlight:!1}),d3.select(this).classed({highlight:!0,lowlight:!1}),B(n)})})}}}))})}function G(){api.cancelRecommendationRequests(),O.transition().style("opacity",0).duration(1e3),O.classed("hidden",!0),d3.selectAll("#countryCount, .on-map-view").classed("hidden",!1),d3.selectAll(".artist-div").remove("div"),d3.selectAll(".close-button").remove("button"),d3.selectAll(".details-h").remove("p"),d3.selectAll(".details-h4").remove("h4"),d3.selectAll(".recom-h4").remove("h4"),d3.selectAll(".artist-control").remove(),d3.selectAll(".topartists-desc").remove(),I.classed("hidden",!0),d3.select("#cnameCont").remove("h1"),d3.select("#cnameCont").remove("h5")}function B(r){var s=[],l=[];d3.select("#summaryText").remove();var c=d3.select("#recommendations").append("div").attr("class","summaryText").attr("id","summaryText");d3.select("#summaryText").append("span").html("Loading description of "+r),d3.select("#summaryText").append("img").attr({id:"sum-loading-img",src:"assets/img/loader_horizontal.gif"}).style({display:"inline-block",margin:"0 5px"}),api.getArtistInfo(r,function(t){var e=t[0].description.replace(/(\n)+/g,"<br />");for(l=t[0].tags,y=0;y<15;y++)for(z=0;z<l.length;z++)l[z]===USER_TAGS[y].tag&&s.push(USER_TAGS[y].tag);var n=s.concat(l);n=n.filter(function(t,e){return n.indexOf(t)==e}),d3.select("#summaryText").html("");var a=.9*d.innerHeight-u.getElementById("artistContainer").offsetHeight;for(c.style("max-height",a+"px"),c.append("h4").html(r),i=0;i<Math.min(n.length,6);i++){var o=c.append("div").attr("class","tagdiv").append("h4").html("#"+n[i]);for(p=0;p<s.length;p++)n[i]===s[p]&&o.classed("usertag",!0)}c.append("p").html(e||"No description available - <a href='https://last.fm/music/"+r+"' target='_blank'>check out last.fm.</a>")})}function H(t,e){(d3.selectAll(".country").classed("highlighted",!1),t)?(d3.selectAll(".country").transition().style("opacity",function(){return+this.id==+e.id?1:.3}),d3.select(u.getElementById(""+e.id)).classed("highlighted",!0)):d3.selectAll(".country").transition().style("opacity",1)}function j(t){var e,n,a,o=m.bounds(t);C(t);var i=o[1][0]-o[0][0],r=o[1][1]-o[0][1];if(i<80&&(i=80),t&&h!==t)switch(h=t,G(),U(t),H(!0,t),t.id){case 840:a=3,e=-(o[1][0]+o[0][0])/3,n=-(o[1][1]+o[0][1])/1.7;break;case 250:a=7.012,e=-(o[1][0]+o[0][0])/1.8,n=-(o[1][1]+o[0][1])/3.4;break;case 528:a=9.0124,e=-(o[1][0]+o[0][0])/1.5,n=-(o[1][1]+o[0][1])/3.3;break;case 643:a=1.9,e=-(o[1][0]+o[0][0])/1.25,n=-(o[1][1]+o[0][1])/2;break;case 554:a=4,e=-(o[1][0]+o[0][0])/.9,n=-(o[1][1]+o[0][1])/1.8;break;case 36:a=3.3,e=-(o[1][0]+o[0][0])/1.8,n=-(o[1][1]+o[0][1])/2.1;break;default:a=.55/Math.max(i/c,r/l),e=-(o[1][0]+o[0][0])/2-c/a/4,n=-(o[1][1]+o[0][1])/2}else e=-c/2,n=-l/2-.08*l,a=1,G(),H(!1),h=null;var s=g.translate();F([s[0]+e*a,s[1]+n*a],a,!0)}nextTheme=function(t){var e=d3.keys(D);o=t||e[(e.indexOf(o)+1)%e.length],colorArray=D[o],d3.select(u.body).attr("class",o),d.localStorage.theme=o,a&&L()},map.nextTheme=nextTheme,nextTheme(o),A(),w(),N(c,l),d.localStorage.countries?f=JSON.parse(d.localStorage.countries):d3.csv("assets/data/countries.csv",function(t,e){(f=e).forEach(function(t){t.id=+t.id}),d.localStorage.countries=JSON.stringify(e)}),d3.json("assets/data/world-50m.json",function(t,e){var n=topojson.feature(e,e.objects.countries).features;M(a=n,!0)}),map.move=F,map.putCountryCount=function(t){countryCount=JSON.parse(JSON.stringify(t)),countryScore=0;var e=[];d3.keys(countryCount).forEach(function(t){countryCount[t][SESSION.name]&&(countryCount[t]=countryCount[t][SESSION.name],countryScore+=1,e.push(+t))}),a&&L(),d.countryScore=countryScore}}(window,document);var screenshot={};!function(d,u){screenshot.render=function(){function t(t){s.font=t.font,s.fillText(t.string,o/2-s.measureText(t.string).width/2,t.y),t.lineWidth&&(s.lineWidth=t.lineWidth,s.strokeStyle=t.strokeStyle,s.strokeText(t.string,o/2-s.measureText(t.string).width/2,t.y))}var e,n=new Image,a=d3.select("#map-svg"),o=a.attr("width"),i=a.attr("height"),r=u.createElement("canvas"),s=r.getContext("2d"),l=d.getComputedStyle(u.body).backgroundColor,c=d.getComputedStyle(u.body).color;r.width=o,r.height=i,a.insert("rect","g").attr({id:"background-rect",width:"100%",height:"100%"}).style({fill:l}),d3.selectAll(".legend text, text.legend").style({"font-family":function(){return d.getComputedStyle(this).fontFamily},"font-size":function(){return d.getComputedStyle(this).fontSize},fill:c}),d3.selectAll(".legend rect").style({stroke:l}),canvg(r,(new XMLSerializer).serializeToString(a[0][0])),n.onload=function(){s.save(),s.globalAlpha=.6,s.fillStyle=l,scoreString=SESSION.total_artists+" artists from "+countryScore+" / 197 countries",e=SESSION.name+"'s musical world map",s.font="34px Patua One",s.fillRect(o/2-s.measureText(e).width/2-20,i-110,s.measureText(e).width+40,100),s.fillStyle=c,s.fillStyle=c,t({string:e,font:"34px Patua One",y:i-60}),t({string:scoreString,font:"20px Didact Gothic",y:i-40}),s.restore(),s.drawImage(n,o-130,i-60,100,36),d3.select("#background-rect").remove(),u.getElementById("screenshot-img").src=r.toDataURL("image/png");r.toDataURL("image/png");u.getElementsByClassName("screenshot-overlay")[0].style=""},n.src="assets/img/explrlogo.png"},screenshot.close=function(){u.getElementsByClassName("screenshot-overlay")[0].style="display:none;"}}(window,document);
//# sourceMappingURL=sourcemaps/all.min.js.map
